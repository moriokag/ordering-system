<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç‚¹çœ¼è–¬ãƒ»åŒ»ç™‚è³‡æ ç™ºæ³¨ãƒ•ã‚©ãƒ¼ãƒ </title>
  <style>
    /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    :root {
      --primary: #2f80ed;
      --primary-light: #e8f1fd;
      --primary-dark: #1c65d1;
      --gray-100: #f8f9fa;
      --gray-200: #e9ecef;
      --gray-300: #dee2e6;
      --gray-400: #ced4da;
      --gray-500: #adb5bd;
      --gray-600: #6c757d;
      --gray-700: #495057;
      --gray-800: #343a40;
      --gray-900: #212529;
      --radius: 8px;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      padding: 0;
      margin: 0;
      background: #f9f9f9;
      color: var(--gray-800);
      line-height: 1.5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    
    header {
      background-color: white;
      padding: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    
    h1 {
      font-size: 1.75rem;
      margin: 0 0 0.5rem 0;
      color: var(--gray-900);
    }
    
    .header-subtitle {
      color: var(--gray-600);
      margin-bottom: 1rem;
    }
    
    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    select, input[type="text"] {
      padding: 0.6rem 1rem;
      width: 100%;
      max-width: 600px;
      font-size: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
    }
    
    /* ã‚¿ãƒ– */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 0.5rem 1rem;
      border-radius: var(--radius);
      background: transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tab:hover {
      background-color: var(--gray-100);
    }
    
    .tab.active {
      background-color: var(--primary);
      color: #fff;
    }
    
    /* å•†å“ãƒªã‚¹ãƒˆ */
    .item-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .item {
      background: white;
      border: 1px solid var(--gray-300);
      padding: 1.2rem;
      border-radius: var(--radius);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    /* ãƒœã‚¿ãƒ³ */
    button {
      padding: 0.5rem 1rem;
      background: white;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    button:hover {
      background: var(--gray-100);
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    /* ã‚«ãƒ¼ãƒˆ */
    .cart-section {
      background: white;
      padding: 1.5rem;
      border-radius: var(--radius);
      margin: 2rem 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .cart-empty {
      text-align: center;
      padding: 2rem;
      color: var(--gray-600);
      background: var(--gray-100);
      border-radius: var(--radius);
      border: 1px dashed var(--gray-400);
    }
    
    /* ãŠæ°—ã«å…¥ã‚Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .favorite-section {
      background: white;
      padding: 1.5rem;
      border-radius: var(--radius);
      margin-bottom: 2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .favorite-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    /* ãŠæ°—ã«å…¥ã‚Šã‚»ãƒƒãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«*/
    .favorite-set-detail {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .favorite-set-detail.show {
      max-height: 500px;
    }

    .toggle-icon {
      cursor: pointer;
      user-select: none;
      margin-right: 0.5rem;
    }
    
    .snackbar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--gray-800);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: var(--radius);
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .snackbar.success {
      background-color: #4caf50;
    }
    
    .snackbar.error {
      background-color: #f44336;
    }

    /* ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒªã‚¢ */
    .debug-area {
      margin-top: 2rem;
      padding: 1rem;
      background: #fffde7;
      border: 1px solid #ffecb3;
      border-radius: var(--radius);
      white-space: pre-wrap;
      font-family: monospace;
      display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯éè¡¨ç¤º */
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>ç‚¹çœ¼è–¬ãƒ»åŒ»ç™‚è³‡æ ç™ºæ³¨ãƒ•ã‚©ãƒ¼ãƒ </h1>
      <p class="header-subtitle">ã‚¯ãƒªãƒ‹ãƒƒã‚¯ç”¨å“ã®ç™ºæ³¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
      
      <select id="requester">
        <option value="">-- ç™ºæ³¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
        <option value="çœ‹è­·å¸«A">çœ‹è­·å¸«A</option>
        <option value="çœ‹è­·å¸«B">çœ‹è­·å¸«B</option>
        <option value="çœ‹è­·å¸«C">çœ‹è­·å¸«C</option>
        <option value="äº‹å‹™ã‚¹ã‚¿ãƒƒãƒ•A">äº‹å‹™ã‚¹ã‚¿ãƒƒãƒ•A</option>
        <option value="äº‹å‹™ã‚¹ã‚¿ãƒƒãƒ•B">äº‹å‹™ã‚¹ã‚¿ãƒƒãƒ•B</option>
      </select>
    </div>
  </header>
  
  <main class="container">
    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 250px;">
        <input type="text" id="searchBox" placeholder="ğŸ” å•†å“åãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ»ãƒ¡ãƒ¼ã‚«ãƒ¼ã§æ¤œç´¢" />
      </div>
      <div>
        <select id="sortOrder" style="width: auto; margin-bottom: 0;">
          <option value="nameAsc">å•†å“å (æ˜‡é †)</option>
          <option value="nameDesc">å•†å“å (é™é †)</option>
          <option value="manufacturerAsc">è£½é€ å…ƒ (æ˜‡é †)</option>
          <option value="manufacturerDesc">è£½é€ å…ƒ (é™é †)</option>
          <option value="categoryAsc">ã‚«ãƒ†ã‚´ãƒª (æ˜‡é †)</option>
        </select>
      </div>
    </div>
    
    <!-- ãŠæ°—ã«å…¥ã‚Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰ -->
    <div class="favorite-section">
      <div class="favorite-header">
        <h2>â­ ãŠæ°—ã«å…¥ã‚Šã‚»ãƒƒãƒˆ</h2>
        <div>
          <input type="text" id="favorite-name" placeholder="ã‚»ãƒƒãƒˆå" style="width: 200px; margin-right: 0.5rem; margin-bottom: 0;">
          <button id="save-favorite" class="btn-primary">ä¿å­˜</button>
        </div>
      </div>
      
      <div id="favorite-sets" style="margin-top: 1rem;"></div>
    </div>
    
    <div class="tabs" id="categoryTabs"></div>
    
    <div id="items" class="item-grid"></div>
    
    <!-- ã‚«ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†ã‚’ä¿®æ­£ -->
    <div class="cart-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>ğŸ›’ æ³¨æ–‡å†…å®¹</h2>
        <button id="clear-cart">ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢</button>
      </div>
      
      <div id="cart"></div>
      
      <button id="submit-btn" class="btn-primary" style="margin-top: 1rem;">
        ğŸ“¤ ç™ºæ³¨æ›¸ã‚’ä½œæˆã™ã‚‹
      </button>
    </div>
    
    <div id="debug-area" class="debug-area"></div>
  </main>

  <script>
    // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰è¨­å®š
    var DEBUG_MODE = true;
    
    // ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
    function debugLog(message) {
      if (!DEBUG_MODE) return;
      
      const debugArea = document.getElementById('debug-area');
      debugArea.style.display = 'block';
      debugArea.textContent += message + '\n';
      console.log(message);
    }
    
    // GASã‹ã‚‰æ¸¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
    var items = <?!= JSON.stringify(items) ?>;
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    var filterText = "";
    var cart = {};
    var activeCategory = "all";
    var sortCriteria = "nameAsc"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¸¦ã¹æ›¿ãˆæ¡ä»¶
    
    // åˆæœŸåŒ–
    function init() {
      debugLog("åˆæœŸåŒ–ã‚’é–‹å§‹ã—ã¾ã™");
      debugLog("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿: " + (items ? items.length : 0) + "ä»¶");
      
      // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
      if (!items) {
        debugLog("è­¦å‘Š: itemsãŒnullã¾ãŸã¯undefinedã§ã™");
        items = [];
      } else if (!Array.isArray(items)) {
        debugLog("è­¦å‘Š: itemsãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“: " + JSON.stringify(items));
        try {
          items = JSON.parse(items); // æ–‡å­—åˆ—ã®å ´åˆã¯ãƒ‘ãƒ¼ã‚¹
        } catch (e) {
          debugLog("ã‚¨ãƒ©ãƒ¼: itemsã‚’ãƒ‘ãƒ¼ã‚¹ã§ãã¾ã›ã‚“: " + e);
          items = [];
        }
      }
      
      if (items.length > 0) {
        debugLog("ã‚µãƒ³ãƒ—ãƒ«å•†å“: " + JSON.stringify(items[0]));
      }
      
      // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('searchBox').addEventListener('input', function() {
        filterText = this.value.trim().toLowerCase();
        renderItems();
      });
      
      // ç™ºæ³¨ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('submit-btn').addEventListener('click', submitOrder);
      
      // ãŠæ°—ã«å…¥ã‚Šä¿å­˜ãƒœã‚¿ãƒ³
      document.getElementById('save-favorite').addEventListener('click', function() {
        const name = document.getElementById('favorite-name').value;
        saveFavoriteSet(name);
      });
      
      // ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã®ä½œæˆ
      renderCategoryTabs();
      
      // å•†å“ä¸€è¦§ã®æç”»
      renderItems();
      
      // ã‚«ãƒ¼ãƒˆæç”»
      updateCartDisplay();
      
      // ãŠæ°—ã«å…¥ã‚Šã‚»ãƒƒãƒˆæç”»
      renderFavoriteSets();

      // ä¸¦ã¹æ›¿ãˆé¸æŠè‚¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('sortOrder').addEventListener('change', function() {
        sortCriteria = this.value;
        renderItems();
      });
      
      debugLog("åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ");
    }
    
    // ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã®ä½œæˆ
    function renderCategoryTabs() {
      const tabsContainer = document.getElementById('categoryTabs');
      
      // ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—
      const categories = ["all"].concat([...new Set(items.map(item => item.category || "æœªåˆ†é¡"))]);
      
      // ã‚¿ãƒ–ã‚’ä½œæˆ
      tabsContainer.innerHTML = '';
      categories.forEach(category => {
        const tab = document.createElement('div');
        tab.className = 'tab' + (category === 'all' ? ' active' : '');
        tab.textContent = category === 'all' ? 'ã™ã¹ã¦' : category;
        tab.onclick = function() {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          activeCategory = category;
          renderItems();
        };
        tabsContainer.appendChild(tab);
      });
      
      debugLog("ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–: " + categories.join(', '));
    }
    
    // å•†å“ä¸€è¦§ã®æç”»
    function renderItems() {
      const container = document.getElementById('items');
      container.innerHTML = '';
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã«åˆã†å•†å“ã‚’è¡¨ç¤º
      const filteredItems = items.filter(item => {
        // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (activeCategory !== 'all' && (item.category || 'æœªåˆ†é¡') !== activeCategory) {
          return false;
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
        if (filterText) {
          const searchFields = [
            item.name,
            item.kana,
            item.category,
            item.manufacturer,
            item.vendor,
            item.note
          ].filter(Boolean).join(' ').toLowerCase();
          
          if (!searchFields.includes(filterText)) {
            return false;
          }
        }
        
        return true;
      });
      
      filteredItems = sortItems(filteredItems, sortCriteria);
      
      if (filteredItems.length === 0) {
        container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--gray-600);">å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        return;
      }
      
      // å•†å“è¡¨ç¤º
      filteredItems.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item';
        
        const name = item.name || "ä¸æ˜ãªå•†å“";
        const manufacturer = item.manufacturer || "ä¸æ˜";
        const vendor = item.vendor || "ä¸æ˜";
        const isOrderable = item.orderable !== "å¦"; // ã€Œä¸å¯ã€ä»¥å¤–ã¯ç™ºæ³¨å¯èƒ½ã¨åˆ¤æ–­
        const unitQty = parseInt(item.unit) || 1;
        const currentQty = cart[name] || 0;
        const size = item.size ? `ã€${item.size}ã€‘` : "";
        
        if (!isOrderable) {
          div.style.opacity = "0.6";
          div.style.backgroundColor = "#f5f5f5";
        }
        
        div.innerHTML = `
          <div style="margin-bottom: 0.5rem;">
            <strong>${name}</strong> ${size}
            ${!isOrderable ? '<span style="background: #f8d7da; color: #721c24; padding: 0.1rem 0.5rem; border-radius: 4px; font-size: 0.8rem; margin-left: 0.5rem;">ç™ºæ³¨ä¸å¯</span>' : ''}
          </div>
          <div style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
            <div>è£½é€ å…ƒ: ${manufacturer}</div>
            <div>ç´å…¥æ¥­è€…: ${vendor}</div>
            ${item.note ? `<div>å‚™è€ƒ: ${item.note}</div>` : ''}
          </div>
          <div>
            <button onclick="changeQty('${name}', -${unitQty})" ${!isOrderable ? 'disabled' : ''}>âˆ’</button>
            <span style="margin: 0 0.5rem;">${currentQty}</span>
            <button onclick="changeQty('${name}', ${unitQty})" ${!isOrderable ? 'disabled' : ''}>ï¼‹</button>
          </div>
        `;
        
        container.appendChild(div);
      });
    }
    
    // æ•°é‡å¤‰æ›´
    // æ•°é‡å¤‰æ›´é–¢æ•°ã®ä¿®æ­£
    function changeQty(name, delta) {
      // è©²å½“å•†å“ã®æƒ…å ±ã‚’å–å¾—
      const item = items.find(item => item.name === name);
      
      // æ³¨æ–‡ä¸å¯ã®å•†å“ã¯å‡¦ç†ã‚’ä¸­æ–­
      if (item && item.orderable === "ä¸å¯") {
        showSnackbar(`ã€Œ${name}ã€ã¯ç¾åœ¨æ³¨æ–‡ã§ãã¾ã›ã‚“`, "error");
        return;
      }
      
      cart[name] = (cart[name] || 0) + delta;
      
      if (cart[name] <= 0) {
        delete cart[name];
      }
      
      updateCartDisplay();
      renderItems(); // æ•°é‡è¡¨ç¤ºã‚’æ›´æ–°
    }

    // ä¸¦ã¹æ›¿ãˆé–¢æ•°
    function sortItems(items, criteria) {
      const sortedItems = [...items]; // é…åˆ—ã‚’ã‚³ãƒ”ãƒ¼
      
      switch (criteria) {
        case "nameAsc":
          sortedItems.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
          break;
        case "nameDesc":
          sortedItems.sort((a, b) => (b.name || "").localeCompare(a.name || ""));
          break;
        case "manufacturerAsc":
          sortedItems.sort((a, b) => (a.manufacturer || "").localeCompare(b.manufacturer || ""));
          break;
        case "manufacturerDesc":
          sortedItems.sort((a, b) => (b.manufacturer || "").localeCompare(a.manufacturer || ""));
          break;
        case "categoryAsc":
          sortedItems.sort((a, b) => (a.category || "").localeCompare(b.category || ""));
          break;
        default:
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯åå‰ã®æ˜‡é †
          sortedItems.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
      }
      
      return sortedItems;
    }
    // ã‚«ãƒ¼ãƒˆè¡¨ç¤º
    // ã‚«ãƒ¼ãƒˆè¡¨ç¤ºé–¢æ•°ã‚’æ”¹å–„
    function updateCartDisplay() {
      const cartContainer = document.getElementById('cart');
      const entries = Object.entries(cart);
      
      if (entries.length === 0) {
        cartContainer.innerHTML = '<div class="cart-empty">ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™</div>';
        return;
      }
      
      // å•†å“ã®åˆè¨ˆç‚¹æ•°ã‚’è¨ˆç®—
      const totalItems = entries.reduce((sum, [_, qty]) => sum + qty, 0);
      
      let html = `
        <div style="margin-bottom: 0.5rem; text-align: right; color: var(--gray-600);">
          åˆè¨ˆ: ${totalItems}ç‚¹
        </div>
        <ul style="list-style: none; padding: 0; margin: 0;">
      `;
      
      entries.forEach(([name, qty]) => {
        html += `
          <li style="display: flex; justify-content: space-between; padding: 0.8rem 0; border-bottom: 1px solid var(--gray-200);">
            <div style="flex: 1; padding-right: 1rem;">${name}</div>
            <div style="display: flex; align-items: center;">
              <button onclick="changeQty('${name}', -1)" style="min-width: 2rem;">âˆ’</button>
              <span style="margin: 0 0.5rem; min-width: 1.5rem; text-align: center;">${qty}</span>
              <button onclick="changeQty('${name}', 1)" style="min-width: 2rem;">ï¼‹</button>
              <button onclick="removeFromCart('${name}')" style="margin-left: 0.5rem; color: var(--gray-600);" title="å‰Šé™¤">Ã—</button>
            </div>
          </li>
        `;
      });
      
      html += '</ul>';
      
      cartContainer.innerHTML = html;
    }
    
    // å•†å“ã‚’ã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤
    function removeFromCart(name) {
      if (confirm(`ã€Œ${name}ã€ã‚’ã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        delete cart[name];
        updateCartDisplay();
        renderItems(); // å•†å“ãƒªã‚¹ãƒˆã®æ•°é‡è¡¨ç¤ºã‚‚æ›´æ–°
        showSnackbar(`ã€Œ${name}ã€ã‚’ã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ`);
      }
    }
    
    // ãŠæ°—ã«å…¥ã‚Šã‚»ãƒƒãƒˆä¿å­˜
    function saveFavoriteSet(name) {
      if (!name) {
        showSnackbar("ã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
        return;
      }
      
      if (Object.keys(cart).length === 0) {
        showSnackbar("ã‚«ãƒ¼ãƒˆã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“", "error");
        return;
      }
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãŠæ°—ã«å…¥ã‚Šã‚’å–å¾—
      const sets = JSON.parse(localStorage.getItem('favoriteSets') || '{}');
      
      // æ—¢å­˜ã®ã‚»ãƒƒãƒˆåãªã‚‰ç¢ºèª
      if (sets[name]) {
        if (!confirm(`ã€Œ${name}ã€ã¯ã™ã§ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) {
          return;
        }
      }
      
      // ã‚»ãƒƒãƒˆã‚’ä¿å­˜
      sets[name] = { ...cart };
      localStorage.setItem('favoriteSets', JSON.stringify(sets));
      
      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('favorite-name').value = '';
      
      // ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ã‚’æ›´æ–°
      renderFavoriteSets();
      
      showSnackbar(`ã€Œ${name}ã€ã‚’ãŠæ°—ã«å…¥ã‚Šã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ`, "success");
    }
    
    // ãŠæ°—ã«å…¥ã‚Šã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿
    // ãŠæ°—ã«å…¥ã‚Šã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿é–¢æ•°ã®ä¿®æ­£
    function loadFavoriteSet(name) {
      const sets = JSON.parse(localStorage.getItem('favoriteSets') || '{}');
      const set = sets[name];
      
      if (!set) return;
      
      // æ³¨æ–‡ä¸å¯ã®å•†å“ã‚’ãƒã‚§ãƒƒã‚¯
      const unavailableItems = [];
      
      // ã‚»ãƒƒãƒˆã®å†…å®¹ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
      Object.entries(set).forEach(([itemName, qty]) => {
        // è©²å½“å•†å“ãŒæ³¨æ–‡å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        const item = items.find(item => item.name === itemName);
        
        if (item && item.orderable === "å¦") {
          unavailableItems.push(itemName);
        } else {
          cart[itemName] = (cart[itemName] || 0) + qty;
        }
      });
      
      updateCartDisplay();
      renderItems();
      
      if (unavailableItems.length > 0) {
        showSnackbar(`ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸãŒã€${unavailableItems.length}ç‚¹ã®å•†å“ã¯ç¾åœ¨æ³¨æ–‡ã§ãã¾ã›ã‚“`, "error");
      } else {
        showSnackbar(`ã€Œ${name}ã€ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ`, "success");
      }
    }
    
    // ãŠæ°—ã«å…¥ã‚Šã‚»ãƒƒãƒˆå‰Šé™¤
    function deleteFavoriteSet(name) {
      if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
      
      const sets = JSON.parse(localStorage.getItem('favoriteSets') || '{}');
      delete sets[name];
      localStorage.setItem('favoriteSets', JSON.stringify(sets));
      
      renderFavoriteSets();
      
      showSnackbar(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, "success");
    }
    
    // ãŠæ°—ã«å…¥ã‚Šã‚»ãƒƒãƒˆä¸€è¦§ã®è¡¨ç¤º
    function renderFavoriteSets() {
      const container = document.getElementById('favorite-sets');
      const sets = JSON.parse(localStorage.getItem('favoriteSets') || '{}');
  
      if (Object.keys(sets).length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 1rem; color: var(--gray-600);">ãŠæ°—ã«å…¥ã‚ŠãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        return;
      }
  
      let html = '';
  
      // å„ãŠæ°—ã«å…¥ã‚Šã‚»ãƒƒãƒˆã‚’è¡¨ç¤º
      Object.entries(sets).forEach(([name, items]) => {
        if (!items || Object.keys(items).length === 0) return;
    
        const totalItems = Object.values(items).reduce((sum, qty) => sum + qty, 0);
        const detailId = `detail-${name.replace(/\s+/g, '-')}`;
    
        html += `
          <div style="border: 1px solid var(--gray-300); border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <div>
                <span class="toggle-icon" data-target="${detailId}">â–¶</span>
                <strong>${name}</strong>
                <span style="background: var(--primary-light); color: var(--primary); padding: 0.1rem 0.5rem; border-radius: 10px; font-size: 0.8rem; margin-left: 0.5rem;">${totalItems}ç‚¹</span>
              </div>
              <div>
                <button onclick="loadFavoriteSet('${name}')">å‘¼ã³å‡ºã™</button>
                <button onclick="deleteFavoriteSet('${name}')" style="margin-left: 0.5rem;">å‰Šé™¤</button>
              </div>
            </div>
        
            <div id="${detailId}" class="favorite-set-detail">
              ${Object.entries(items).map(([itemName, qty]) => `
                <div style="display: flex; justify-content: space-between; padding: 0.2rem 0; border-bottom: 1px solid var(--gray-200);">
                  <span>${itemName}</span>
                  <span>${qty}å€‹</span>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });
  
      container.innerHTML = html;
  
      // è©³ç´°è¡¨ç¤ºã®ãƒˆã‚°ãƒ«å‡¦ç†ã‚’è¿½åŠ 
      document.querySelectorAll('.toggle-icon').forEach(icon => {
        icon.addEventListener('click', function() {
          const targetId = this.getAttribute('data-target');
          const detailElement = document.getElementById(targetId);
      
          // è¡¨ç¤ºçŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
          const isShowing = detailElement.classList.contains('show');
          detailElement.classList.toggle('show');
      
          // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´
          this.textContent = isShowing ? 'â–¶' : 'â–¼';
        });
      });
    }

    // ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼é€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showSnackbar(message, type = 'default') {
      // æ—¢å­˜ã®ã‚¹ãƒŠãƒƒã‚¯ãƒãƒ¼ã‚’æ¢ã™
      let snackbar = document.getElementById('snackbar');
      
      // ãªã‘ã‚Œã°ä½œæˆ
      if (!snackbar) {
        snackbar = document.createElement('div');
        snackbar.id = 'snackbar';
        snackbar.className = 'snackbar';
        document.body.appendChild(snackbar);
      }
      
      // ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
      snackbar.className = 'snackbar';
      if (type === 'success') {
        snackbar.classList.add('success');
      } else if (type === 'error') {
        snackbar.classList.add('error');
      }
      
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
      snackbar.textContent = message;
      
      // è¡¨ç¤ºã™ã‚‹
      snackbar.style.opacity = '1';
      
      // 3ç§’å¾Œã«éè¡¨ç¤ºã«ã™ã‚‹
      setTimeout(() => {
        snackbar.style.opacity = '0';
      }, 3000);
    }
    // ã‚«ãƒ¼ãƒˆã‚¯ãƒªã‚¢æ©Ÿèƒ½ã‚’è¿½åŠ 
    function clearCart() {
      if (Object.keys(cart).length === 0) return; // ã‚«ãƒ¼ãƒˆãŒç©ºãªã‚‰ä½•ã‚‚ã—ãªã„
      
      if (confirm("ã‚«ãƒ¼ãƒˆã‚’ç©ºã«ã—ã¾ã™ã‹ï¼Ÿ")) {
        cart = {}; // ã‚«ãƒ¼ãƒˆã‚’ç©ºã«ã™ã‚‹
        updateCartDisplay(); // ã‚«ãƒ¼ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
        renderItems(); // å•†å“ãƒªã‚¹ãƒˆã®æ•°é‡è¡¨ç¤ºã‚‚æ›´æ–°
        showSnackbar("ã‚«ãƒ¼ãƒˆã‚’ç©ºã«ã—ã¾ã—ãŸ", "success");
      }
    }
    
    // åˆæœŸåŒ–æ™‚ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    // inité–¢æ•°å†…ã«ä»¥ä¸‹ã‚’è¿½åŠ 
    document.getElementById('clear-cart').addEventListener('click', clearCart);    

    // ç™ºæ³¨å‡¦ç†
    function submitOrder() {
      const requester = document.getElementById('requester').value;
      
      if (!requester) {
        showSnackbar('ç™ºæ³¨è€…ã‚’é¸æŠã—ã¦ãã ã•ã„', "error");
        document.getElementById('requester').focus();
        return;
      }
      
      if (Object.keys(cart).length === 0) {
        showSnackbar('ã‚«ãƒ¼ãƒˆã«å•†å“ãŒã‚ã‚Šã¾ã›ã‚“', "error");
        return;
      }
      
      const now = new Date();
      const orderText = `ã€ç‚¹çœ¼è–¬ãƒ»åŒ»ç™‚è³‡æ ç™ºæ³¨æ›¸ã€‘\n` +
                       `ç™ºæ³¨æ—¥æ™‚: ${now.toLocaleDateString('ja-JP')} ${now.toLocaleTimeString('ja-JP')}\n` +
                       `ç™ºæ³¨è€…: ${requester}\n\n` +
                       `â–  ç™ºæ³¨å†…å®¹\n` +
                       Object.entries(cart)
                         .map(([name, qty]) => `ãƒ»${name}: ${qty}å€‹`)
                         .join('\n');
      
      const blob = new Blob([orderText], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ç™ºæ³¨æ›¸_${now.toLocaleDateString('ja-JP').replace(/\//g, '')}.txt`;
      a.click();

      showSnackbar('ç™ºæ³¨æ›¸ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ', "success");
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    window.onload = function() {
      try {
        init();
      } catch (e) {
        debugLog("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + e.message);
        console.error(e);
      }
    };
  </script>
</body>
</html>